# Courtesy of Federico Ficarelli
ARG TAGS=ghcr.io/kuleuven-micas/snax:main

FROM ${TAGS}-fifo-1 as deps-fifo-1
FROM ${TAGS}-fifo-2 as deps-fifo-2
FROM ${TAGS}-fifo-3 as deps-fifo-3
FROM ${TAGS}-fifo-4 as deps-fifo-4

FROM ubuntu:18.04 as toolchain

# shared dependencies
COPY --from=deps-fifo-2 /opt /opt

COPY --from=deps-fifo-1 /opt /opt-fifo-1
COPY --from=deps-fifo-2 /opt /opt-fifo-2
COPY --from=deps-fifo-3 /opt /opt-fifo-3
COPY --from=deps-fifo-4 /opt /opt-fifo-4



FROM ubuntu:18.04 as toolchain
# shared dependencies
# libc for memset from old toolchain
COPY --from=deps /opt/snitch-llvm/riscv32-unknown-elf/lib /opt/snitch-llvm/riscv32-unknown-elf/lib
# libclang_rt.builtins_riscv32 from old toolchain
COPY --from=deps /opt/snitch-llvm/lib/clang/12.0.1/lib /opt/snitch-llvm/lib/clang/12.0.1/lib
COPY --from=deps /opt/python3.11 /opt/python3.11
COPY --from=deps /src/util/trace /opt/snitch_cluster/util/trace
COPY --from=snax-streamer-gemm /opt/snitch-spike /opt/snitch-spike

RUN apt-get -y update \
 && apt-get -y upgrade \
 # python runtime dependencies
 && apt-get -y install \
      wget \
      zlib1g \
      libncurses5 \
      libgdbm5 \
      libnss3 \
      libssl1.1 \
      libreadline7 \
      libffi6 \
      libsqlite3-0 \
      bzip2 \
# make pip able to install via git
 && apt-get -y install git \
# mlir and clang
 && apt-get -y install wget lsb-release software-properties-common gnupg \
 && wget https://apt.llvm.org/llvm.sh && chmod +x llvm.sh && ./llvm.sh 17 && rm llvm.sh \
 && apt-get -y install mlir-17-tools \
# make
 && apt-get -y install make

# add python3.11 to path in bashrc
RUN echo "export PATH=/opt/python3.11/bin:$PATH" >> ~/.bashrc


# install python requirements
RUN export PATH=/opt/python3.11/bin:$PATH \
 && git clone https://github.com/kuleuven-micas/snax-mlir.git \
 && cd snax-mlir \
 && pip3 install -r requirements.txt
