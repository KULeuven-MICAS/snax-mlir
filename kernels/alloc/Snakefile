from util.snake.configs import get_snax_mac_config
from util.snake.paths import get_traces

config = get_snax_mac_config()

config["snaxoptflags"] = ",".join(
    [
        "preprocess",
        "dispatch-kernels",
        "set-memory-space",
        "set-memory-layout",
        "realize-memref-casts",
        "reuse-memref-allocs",
        "insert-sync-barrier",
        "dispatch-regions",
        "snax-copy-to-dma",
        "memref-to-snax",
        "snax-to-func",
        "clear-memory-space",
        "postprocess",
    ]
)


module default_rules:
    snakefile:
        "../../util/snake/default_rules.smk"
    config:
        config


files = ["func"]


rule all:
    input:
        *get_traces(files, config["num_chips"], config["num_harts"], "dasm"),


use rule * from default_rules exclude compile_simple_main as default_*


rule compile_snax_binary:
    input:
        "func.o",
        "main.o",
    output:
        "func.x",
    shell:
        "{config[ld]} {config[ldflags]} {input} -o {output}"
