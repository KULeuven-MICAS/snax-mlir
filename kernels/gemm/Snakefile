from util.snake.configs import get_snax_gemmx_config

config = get_snax_gemmx_config()
config["mlirpreprocflags"] = [
    "--linalg-generalize-named-ops",
    "--mlir-print-op-generic",
    "--mlir-print-local-scope",
]


module default_rules:
    snakefile:
        "../../util/snake/default_rules.smk"
    config:
        config


use rule * from default_rules exclude mlir_preprocessing as default_*


rule preprocess_mlir:
    input:
        "{file}.generated.mlir",
    output:
        temp("{file}.preprocfinal.mlir"),
    run:
        shell(
            "{config[mlir-opt]} {config[mlirpreprocflags]} -o {wildcards.file}.preprocfinal.mlir {input}"
        )


rule all:
    input:
        "gemm.x",
    shell:
        "{config[vltsim]} {input[0]}"
